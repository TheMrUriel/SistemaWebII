<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {%load static%}
    <link rel="stylesheet" href="{% static 'TransporteApp/style.css' %}" />
    <title>Iniciar Sesión</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
       const firebaseConfig = {
        apiKey: "AIzaSyCDdHMlS8qfiiVfdFvQIe3GoiZVssLCkMM",
        authDomain: "tgvg-foraneos.firebaseapp.com",
        databaseURL: "https://tgvg-foraneos.firebaseio.com",
        projectId: "tgvg-foraneos",
        storageBucket: "tgvg-foraneos.appspot.com",
        messagingSenderId: "230877081732",
        appId: "1:230877081732:web:b78113f20ad5cb699412d1",
        measurementId: "G-KFXQZZJCJJ"
      };

      // Inicializa Firebase
      firebase.initializeApp(firebaseConfig);

      // Inicializa Firestore y Auth
      const auth = firebase.auth();
      const db = firebase.firestore(); // Inicializa Firestore

      // Redirigir si ya hay una sesión iniciada
      auth.onAuthStateChanged((user) => {
        if (user) {
          // Hay un usuario con sesión iniciada
          db.collection('usuarios').where('email', '==', user.email).get()
          .then((querySnapshot) => {
            if (!querySnapshot.empty) {
              const doc = querySnapshot.docs[0];
              const tipoUsuario = doc.data().tipo;
              if (tipoUsuario === 1) {
                window.location.href = "/home";
              } else if (tipoUsuario === 3) {
                window.location.href = "/viajesDisponibles";
              } else {
                alert("Tipo de usuario no válido");
              }
            } else {
              alert("El usuario no existe");
            }
          })
          .catch((error) => {
            console.error("Error al obtener el tipo de usuario: ", error);
          })
          .finally(() => {
            // Ocultar la pantalla de carga al final
            document.getElementById("loading-screen").style.display = "none";
          });
        } else {
          // No hay sesión iniciada, ocultar la pantalla de carga
          document.getElementById("loading-screen").style.display = "none";
        }
      });

    </script>
    </head>

  <body>
    <section class="contenedor_principal">
      <div class="contenedor_logo">
        <img src="{% static 'TransporteApp/logo.png' %}" class="logo" alt="Logo de la empresa">
      </div>

      <div class="contenedor_formulario">
        <div class="contenedor_formulario_titulo">
          <h2 class="formulario_titulo">Bienvenido!</h2>
        </div>
        <div class="contenedor_formulario_cuerpo">
          <form id="login-form">
            {% csrf_token %}
            <div class="contenedor_formulario_inputs">
              <label for="username">
                <span class="input_titulo">
                  Usuario
                </span>
              </label>
              <div class="contenedor_input_contenido">
                <input type="text" class="input_contenido" name="email" id="email" placeholder="Usuario">
              </div>
            </div>
            <div class="contenedor_formulario_inputs">
              <label for="password">
                <span class="input_titulo">
                  Contraseña
                </span>
              </label>
              <div class="contenedor_input_contenido">
                <input type="password" class="input_contenido" name="password" id="password" placeholder="Contraseña">
              </div>
            </div>
            <div class="contenedor_formulario_inputs">
              <input type="checkbox" id="remember_me">
              <label for="remember_me">
                <span class="input_titulo">
                  Recuerdame
                </span>
              </label>
            </div>
            <div class="contenedor_formulario_inputs">
              <div class="contenedor_enlace_contrasena">
                <a href="#" class="enlace_contrasena">Olvido su contraseña?</a>
              </div>
            </div>
            <div class="contenedor_formulario_inputs">
              <div class="contenedor_boton_login">
                <button type="submit" class="boton_login">Iniciar Sesión</button>
              </div>
            </div>
            <div class="contenedor_formulario_inputs">
              <div class="contenedor_boton_signup">
                <a href="registro/" class="boton_signup">Registrarse</a>
              </div>
            </div>
          </form>
          <script>
            document.getElementById("login-form").addEventListener("submit", function(event) {
              event.preventDefault(); // Prevenir el envío del formulario
              
              const email = document.getElementById("email").value;
              const password = document.getElementById("password").value;
              
              auth.signInWithEmailAndPassword(email, password)
              .then((userCredential) => {
                // Usuario autenticado
                return db.collection('usuarios').where('email', '==', email).get(); // Consultar por el campo "email"
              })
              .then((querySnapshot) => {
                if (!querySnapshot.empty) {
                  const doc = querySnapshot.docs[0]; // Obtener el primer documento que coincida
                  const tipoUsuario = doc.data().tipo;
                  if (tipoUsuario === 1) {
                    window.location.href = "/menuMonitorista";
                  } else if (tipoUsuario === 3) {
                    window.location.href = "/menuChofer";
                  } else {
                    // Manejar otros tipos de usuario o errores
                    alert("Tipo de usuario no válido");
                  }
                } else {
                  // Manejar el caso en que el usuario no existe
                  alert("El usuario no existe");
                }
              })
              .catch((error) => {
                alert("Error al iniciar sesión: " + error.message);
              });
            });
          </script>
        </div>
      </div>
    </section>
    <div id="loading-screen" style="display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; color:#fff; background-color: rgba(0, 0, 0); z-index: 1000;">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only" color="white">Cargando...</span>
      </div>
    </div>
  </body>
</html>